<%@ page language="java" contentType="text/html; charset=UTF-8"
	pageEncoding="UTF-8"%>
<%@include file="../includes/header.jsp"%>
<head>
<link rel="stylesheet" type="text/css"
	href="../../../resources/css/list.css" />
<link rel="stylesheet" type="text/css"
	href="../../../resources/css/common.css" />
<link rel="stylesheet" type="text/css"
	href="../../../resources/css/register.css" />
<style>
td.table-light {
	width: 12%;
	vertical-align: middle;
	text-align: center;
}

input[type="checkbox"] {
	width: 15px;
	height: 15px;
}

label {
	float: left;
}

select.input_width20 {
	float: left;
	font-size: 0.9rem;
	padding: 5px 3px;
	width: -webkit-fill-available;
	border-radius: 4px;
	border-color: ghostwhite;
}

td {
	vertical-align: middle !important;
}

button.btn.btn-secondary.btn-sm {
	float: right;
}
</style>
</head>
<div class="right-container">
	<h1>
		<b>신규 취약점 등록 </b>
	</h1>
	<hr>
	<form id="form" action="register" method="post"
		onsubmit="return false;">
		<table class="table table-bordered">
			<tr>
				<td class="table-light" colspan="2">취약점명</td>
				<td colspan="6"><input type="text" name="VulName"
					class="input_width100" placeholder="취약점명 입력"></td>
			</tr>
			<tr>
				<td class="table-light" colspan="2">제조사</td>
				<td colspan="6"><select class="input_width100"
					name="Vul_Manufacturer">
						<c:forEach items="${manufacturer}" var="mf">
							<option value="${mf}">${mf}</option>
						</c:forEach>
				</select></td>
			</tr>
			<tr>
				<td class="table-light" colspan="2">모델</td>
				<td colspan="2"><select class="input_width100" name="Val_model">
						<c:forEach items="${models}" var="model" varStatus="status">
							<option value="${model}">${model}</option>
						</c:forEach>
				</select></td>
				<td class="table-light" colspan="2">시스템S/W유형</td>
				<td colspan="2"><select class="input_width100"
					name="Val_systemSW">
						<option value="Windows">Windows</option>
						<option value="UNIX">UNIX</option>
						<option value="Linux">Linux</option>
						<option value="Firmware">Firmware</option>
				</select></td>
			</tr>
			<tr>
				<td class="table-light" colspan="2">획득일자</td>
				<td colspan="2"><input type='date' id="acqdate"
					class="input_width100" onchange="input()"> <input
					type='hidden' name='VulAcqDate' class="input_width100"
					id="VulAcqDate"></td>
				<td class="table-light" colspan="2">획득경로</td>
				<td colspan="2"><select class="input_width100"
					name="Vul_AcqPath">
						<option value="자체">자체</option>
						<option value="KISA">KISA</option>
						<option value="산업부 사이버안전센터">산업부 사이버안전센터</option>
				</select></td>
			</tr>

			<tr>
				<td class="table-light" colspan="2">취약점 내용</td>
				<td colspan="6">
					<textarea class="input_width100" rows="10"
						placeholder="취약점 내용 입력" name="Vul_content"></textarea></td>
			</tr>
			<tr>
				<td class="table-light" colspan="2">조치방법</td>
				<td colspan="6"><textarea class="input_width100" rows="10"
						placeholder="조치 내용 입력" name="Vul_actionMehtod"></textarea></td>
			</tr>
			<tr>
				<td class="table-light" colspan="2" rowspan="3">관련 통제항목</td>
				<td colspan="6"><label>통제항목 분류</label><br> <select
					id="ci-js" class="input_width20"
					onchange="javascript:select_ci(this);">
						<option value="1">기술적</option>
						<option value="2">운영적</option>
						
				</select></td>
			</tr>
			<tr>
				<td colspan="6">
					<table class="table table-hover" id="table1">
						<thead>
							<tr>
								<th scope="col" style="width: 11%;">상세분류번호</th>
								<th scope="col" style="width: 11%;">통제항복분류</th>
								<th scope="col" style="width: 11%;">상세분류</th>
								<th scope="col">항목내용</th>
							</tr>
						</thead>
						<tbody id="select_ci_list">

						</tbody>
					</table>
				</td>
			</tr>
			<tr>
				<td colspan="6"><div>
						<label>선택된 통제항목</label>
						<button type="button" class="btn btn-secondary btn-sm"
							onclick="reset_ci()">관련 통제항목 없음</button>
					</div>
					<br> <br>
					<table class="table">
						<tbody>
							<tr id="select_ci_list-checked">
							</tr>
						</tbody>

					</table> <input type="hidden" name="vul_ci_id" value=""></td>
			</tr>
		</table>
		<div class="table_button_group">
			<button type="button" class="btn btn-danger" data-toggle="modal"
				data-target="#staticBackdrop" onclick="alertRegister()">등록</button>
		</div>
	</form>
</div>
<script>
	$(document).ready(function() {
		var ci_index = document.getElementById("ci-js");

		console.log(ci_index);
		select_ci(ci_index);
	});

	function reset_ci() {
		if (confirm("관련 통제항목을 삭제하시겠습니까?") == true) {
			alert("관련 통제항목이 삭제되었습니다.");
			var getTag = $("#select_ci_list-checked").empty();
			$('input[name=vul_ci_id]').val(null);
		} else {
			return;
		}
	}

	function select(val) {
		var target = document.getElementsByClassName("tr_items");
		//target[val].style.backgroundColor = "rgb(146 171 198 / 25%)";
		var cells = target[val].getElementsByTagName("td");
		alert(cells[0].firstChild.data + "번이 관련 통제항목으로 지정되었습니다.");

		var getTag = $("#select_ci_list-checked").empty();

		var insTag = "";

		insTag += "<td style='width: 11%;'>" + cells[0].firstChild.data
				+ "</td>";
		insTag += "<td style='width: 11%;'>" + cells[1].firstChild.data
				+ "</td>";
		insTag += "<td style='width: 11%;'>" + cells[2].firstChild.data
				+ "</td>";
		insTag += "<td>" + cells[3].firstChild.data + "</td>";

		$("#select_ci_list-checked").html(insTag);
		$('input[name=vul_ci_id]').val(cells[0].firstChild.data);
	}

	function alertRegister() {
		var x = $('input[name=vul_ci_id]').val()
		console.log(x)
		if (confirm("신규 취약점을 등록하시겠습니까?") == true) {
			alert("등록되었습니다");
			document.getElementById('form').submit();
			//location.href = "new_vulnerability_detail.html";
		} else {
			return;
		}
	}
	function select_ci(obj) {
		console.log(obj.value);
		var number = obj.value;
		$.ajax({
			contentType : "application/json; charset=utf-8;",
			dataType : "json",
			type : "GET",
			url : "/vulnerability/select_ci_number",
			data : {
				"number" : number

			},
			success : function(data) {
				if (!data) {
					alert("null");
				}
				//console.log(data[0]);

				var getTag = $("#select_ci_list").empty();

				var insTag = "";

				for (var i = 0; i < data.length; i++) {
					//console.log(data[i]);
					insTag += "<tr class='tr_items'>";
					insTag += "<td id='ci_detail_id'>" + data[i].ci_detail_id
							+ "</td>";
					insTag += "<td id='ci_type'>" + data[i].ci_type + "</td>";
					insTag += "<td id='ci_detailType'>" + data[i].ci_detailType
							+ "</td>";
					insTag += "<td id='ci_content'>" + data[i].ci_content
							+ "</td>";
					insTag += "</tr>";
					//console.log(insTag);
				}
				$("#select_ci_list").html(insTag);

				$('.tr_items').each(function(index) {
					$(this).attr('menu-index', index);
				}).click(function() {
					var index = $(this).attr('menu-index');
					select(index);
				});
			},
			error : function(request, status, error) {
				alert("error");

			}
		})
	}
	function input() {
		const dday = document.querySelector("#acqdate").value;

		$("#VulAcqDate").val(dday.toString().substr(0, 10));
	}
</script>
<%@include file="../includes/footer.jsp"%>